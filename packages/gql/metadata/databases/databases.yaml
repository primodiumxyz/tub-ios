- name: default
  kind: postgres
  configuration:
    connection_info:
      database_url:
        from_env: PG_DATABASE_URL
      isolation_level: read-committed
      use_prepared_statements: false
  customization:
    naming_convention: hasura-default
  logical_models:
    - fields:
        - name: balance
          type:
            nullable: false
            scalar: numeric
      name: balance_offset_model
      select_permissions:
        - permission:
            columns:
              - balance
            filter: {}
          role: public
    - fields:
        - name: id
          type:
            nullable: false
            scalar: uuid
        - name: token
          type:
            nullable: false
            scalar: text
        - name: amount
          type:
            nullable: false
            scalar: numeric
        - name: wallet
          type:
            nullable: false
            scalar: varchar
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: token_transaction_offset_model
    - fields:
        - name: id
          type:
            nullable: false
            scalar: uuid
        - name: wallet
          type:
            nullable: false
            scalar: varchar
        - name: amount
          type:
            nullable: false
            scalar: numeric
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: wallet_transaction_offset_model
  native_queries:
    - arguments:
        offset:
          description: ""
          nullable: false
          type: interval
      code: SELECT  token_transaction.id,  token_transaction.token,  token_transaction.amount,
        wallet_transaction.wallet, created_at, created_at + {{offset}} as
        created_at_offset from token_transaction inner JOIN wallet_transaction
        on token_transaction.wallet_transaction = wallet_transaction.id
      returns: token_transaction_offset_model
      root_field_name: token_transaction_offset
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
        wallet:
          description: ""
          nullable: false
          type: varchar
      code: >-
        SELECT COALESCE(SUM(wallet_transaction_offset.amount), 0) as balance

        from  (SELECT *, created_at + {{interval}} as created_at_offset from
        wallet_transaction) as wallet_transaction_offset

        where wallet_transaction_offset.wallet = {{wallet}} and
        wallet_transaction_offset.created_at_offset <= {{start}}
      returns: balance_offset_model
      root_field_name: wallet_balance_ignore_interval
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
        token:
          description: ""
          nullable: false
          type: text
        wallet:
          description: ""
          nullable: false
          type: varchar
      code: >-
        SELECT 
            COALESCE(SUM(token_transaction_offset.amount), 0) AS balance
        FROM (
            SELECT  
                token_transaction.id,  
                token_transaction.token,  
                token_transaction.amount, 
                wallet_transaction.wallet, 
                wallet_transaction.created_at, 
                wallet_transaction.created_at + {{interval}} AS created_at_offset
            FROM 
                token_transaction
            INNER JOIN 
                wallet_transaction 
            ON 
                token_transaction.wallet_transaction = wallet_transaction.id
        ) AS token_transaction_offset

        WHERE 
            token_transaction_offset.wallet = {{wallet}} 
            AND token_transaction_offset.token = {{token}} 
            AND token_transaction_offset.created_at_offset <= {{start}};
      returns: balance_offset_model
      root_field_name: wallet_token_balance_ignore_interval
    - arguments:
        offset:
          description: ""
          nullable: false
          type: interval
      code: select *, created_at + {{offset}} as created_at_offset from
        wallet_transaction
      returns: wallet_transaction_offset_model
      root_field_name: wallet_transaction_offset
  tables: "!include default/tables/tables.yaml"
  functions: "!include default/functions/functions.yaml"
- name: timescaledb
  kind: postgres
  configuration:
    connection_info:
      database_url:
        from_env: TIMESCALE_DATABASE_URL
      isolation_level: read-committed
      use_prepared_statements: false
      is_data_source_only: true
      read_replicas: []
      manage_metadata: false
  tables: "!include timescaledb/tables.yaml"
  functions: "!include timescaledb/functions.yaml"
  types: "!include timescaledb/types.yaml"
