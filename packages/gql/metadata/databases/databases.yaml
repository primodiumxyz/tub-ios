- name: default
  kind: postgres
  configuration:
    connection_info:
      database_url:
        from_env: PG_DATABASE_URL
      isolation_level: read-committed
      use_prepared_statements: false
  customization:
    naming_convention: hasura-default
  logical_models:
    - fields:
        - name: token_id
          type:
            nullable: false
            scalar: uuid
        - name: mint
          type:
            nullable: false
            scalar: text
        - name: name
          type:
            nullable: false
            scalar: varchar
        - name: symbol
          type:
            nullable: false
            scalar: varchar
        - name: latest_price
          type:
            nullable: false
            scalar: numeric
        - name: increase_pct
          type:
            nullable: false
            scalar: float8
        - name: trades
          type:
            nullable: false
            scalar: bigint
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: account_transaction_offset_model
    - fields:
        - name: balance
          type:
            nullable: false
            scalar: numeric
      name: balance_offset_model
      select_permissions:
        - permission:
            columns:
              - balance
            filter: {}
          role: public
    - fields:
        - name: token_id
          type:
            nullable: false
            scalar: uuid
        - name: mint
          type:
            nullable: false
            scalar: text
        - name: name
          type:
            nullable: true
            scalar: varchar
        - name: symbol
          type:
            nullable: true
            scalar: varchar
        - name: description
          type:
            nullable: true
            scalar: text
        - name: uri
          type:
            nullable: true
            scalar: text
        - name: supply
          type:
            nullable: true
            scalar: numeric
        - name: decimals
          type:
            nullable: true
            scalar: integer
        - name: mint_burnt
          type:
            nullable: true
            scalar: boolean
        - name: freeze_burnt
          type:
            nullable: true
            scalar: boolean
        - name: is_pump_token
          type:
            nullable: true
            scalar: boolean
        - name: increase_pct
          type:
            nullable: false
            scalar: float8
        - name: trades
          type:
            nullable: false
            scalar: bigint
        - name: volume
          type:
            nullable: false
            scalar: numeric
        - name: latest_price
          type:
            nullable: false
            scalar: numeric
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
      name: formatted_tokens_model
      select_permissions:
        - permission:
            columns:
              - token_id
              - mint
              - name
              - symbol
              - description
              - uri
              - supply
              - decimals
              - mint_burnt
              - freeze_burnt
              - is_pump_token
              - increase_pct
              - trades
              - volume
              - latest_price
              - created_at
            filter: {}
          role: public
    - fields:
        - name: token_id
          type:
            nullable: false
            scalar: uuid
        - name: mint
          type:
            nullable: false
            scalar: text
        - name: name
          type:
            nullable: true
            scalar: varchar
        - name: symbol
          type:
            nullable: true
            scalar: varchar
        - name: description
          type:
            nullable: true
            scalar: text
        - name: uri
          type:
            nullable: true
            scalar: text
        - name: supply
          type:
            nullable: true
            scalar: numeric
        - name: decimals
          type:
            nullable: true
            scalar: integer
        - name: mint_burnt
          type:
            nullable: true
            scalar: boolean
        - name: freeze_burnt
          type:
            nullable: true
            scalar: boolean
        - name: is_pump_token
          type:
            nullable: true
            scalar: boolean
        - name: increase_pct
          type:
            nullable: false
            scalar: float8
        - name: trades
          type:
            nullable: false
            scalar: bigint
        - name: volume
          type:
            nullable: false
            scalar: numeric
        - name: latest_price
          type:
            nullable: false
            scalar: numeric
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: trades_after
          type:
            nullable: false
            scalar: text
        - name: increase_pct_after
          type:
            nullable: false
            scalar: text
        - name: volume_after
          type:
            nullable: false
            scalar: text
        - name: interval_start
          type:
            nullable: false
            scalar: timestamptz
      name: formatted_tokens_with_performance_model
      select_permissions:
        - permission:
            columns:
              - token_id
              - mint
              - name
              - symbol
              - description
              - uri
              - supply
              - decimals
              - mint_burnt
              - freeze_burnt
              - is_pump_token
              - increase_pct
              - trades
              - volume
              - latest_price
              - created_at
              - trades_after
              - increase_pct_after
              - volume_after
              - interval_start
            filter: {}
          role: public
    - fields:
        - name: id
          type:
            nullable: false
            scalar: uuid
        - name: token
          type:
            nullable: false
            scalar: uuid
        - name: price
          type:
            nullable: false
            scalar: numeric
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: internal_token_transaction_ref
          type:
            nullable: true
            scalar: uuid
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: token_price_history_offset
      select_permissions:
        - permission:
            columns:
              - id
              - token
              - price
              - created_at
              - internal_token_transaction_ref
              - created_at_offset
            filter: {}
          role: public
    - fields:
        - name: id
          type:
            nullable: false
            scalar: uuid
        - name: token
          type:
            nullable: false
            scalar: uuid
        - name: amount
          type:
            nullable: false
            scalar: numeric
        - name: wallet
          type:
            nullable: false
            scalar: varchar
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: token_transaction_offset_model
    - fields:
        - name: interval_start
          type:
            nullable: false
            scalar: timestamptz
        - name: total_volume
          type:
            nullable: false
            scalar: numeric
        - name: token_count
          type:
            nullable: false
            scalar: bigint
      name: volume_intervals_within_period
      select_permissions:
        - permission:
            columns:
              - interval_start
              - total_volume
              - token_count
            filter: {}
          role: public
    - fields:
        - name: id
          type:
            nullable: false
            scalar: uuid
        - name: wallet
          type:
            nullable: false
            scalar: varchar
        - name: amount
          type:
            nullable: false
            scalar: numeric
        - name: created_at
          type:
            nullable: false
            scalar: timestamptz
        - name: created_at_offset
          type:
            nullable: false
            scalar: timestamptz
      name: wallet_transaction_offset_model
  native_queries:
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
      code: SELECT * FROM get_formatted_tokens_interval({{interval}})
      returns: formatted_tokens_model
      root_field_name: formatted_tokens_interval
    - arguments:
        after_intervals:
          description: ""
          nullable: false
          type: text
        end:
          description: ""
          nullable: false
          type: timestamptz
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
      code: SELECT * FROM get_formatted_tokens_with_performance_intervals_within_period({{start}}, {{end}}, {{interval}}, {{after_intervals}});
      returns: formatted_tokens_with_performance_model
      root_field_name: formatted_tokens_with_performance_intervals_within_period
    - arguments:
        offset:
          description: ""
          nullable: false
          type: interval
      code: SELECT *, created_at + {{offset}} as created_at_offset from token_price_history
      returns: token_price_history_offset
      root_field_name: token_price_history_offset
    - arguments:
        offset:
          description: ""
          nullable: false
          type: interval
      code: SELECT  token_transaction.id,  token_transaction.token,  token_transaction.amount, wallet_transaction.wallet, created_at, created_at + {{offset}} as created_at_offset from token_transaction inner JOIN wallet_transaction on token_transaction.wallet_transaction = wallet_transaction.id
      returns: token_transaction_offset_model
      root_field_name: token_transaction_offset
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
        end:
          description: ""
          nullable: false
          type: timestamptz
      code: "WITH RECURSIVE intervals AS (\n    -- Base case: first interval\n    SELECT \n        {{start}}::timestamptz as interval_start,\n        least({{start}}::timestamptz + {{interval}}::interval, {{end}}::timestamptz) as interval_end\n    \n    UNION ALL\n    \n    -- Recursive case: subsequent intervals\n    SELECT\n        interval_end,\n        least(interval_end + {{interval}}::interval, {{end}}::timestamptz)\n    FROM intervals\n    WHERE interval_end < {{end}}::timestamptz\n),\nvolume_stats AS (\n    SELECT \n        i.interval_start,\n        i.interval_end,\n        COALESCE(SUM(tph.price), 0) as total_volume,\n        COUNT(DISTINCT t.id) as token_count\n    FROM intervals i\n    LEFT JOIN token_price_history tph ON \n        tph.created_at >= i.interval_start AND \n        tph.created_at < i.interval_end\n    LEFT JOIN token t ON \n        t.id = tph.token AND \n        t.mint IS NOT NULL\n    GROUP BY i.interval_start, i.interval_end\n)\nSELECT \n    interval_start,\n    total_volume,\n    token_count\nFROM volume_stats\nORDER BY interval_start;"
      returns: volume_intervals_within_period
      root_field_name: volume_intervals_within_period
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
        wallet:
          description: ""
          nullable: false
          type: varchar
      code: |-
        SELECT COALESCE(SUM(wallet_transaction_offset.amount), 0) as balance
        from  (SELECT *, created_at + {{interval}} as created_at_offset from wallet_transaction) as wallet_transaction_offset
        where wallet_transaction_offset.wallet = {{wallet}} and wallet_transaction_offset.created_at_offset <= {{start}}
      returns: balance_offset_model
      root_field_name: wallet_balance_ignore_interval
    - arguments:
        interval:
          description: ""
          nullable: false
          type: interval
        start:
          description: ""
          nullable: false
          type: timestamptz
        token:
          description: ""
          nullable: false
          type: uuid
        wallet:
          description: ""
          nullable: false
          type: varchar
      code: "SELECT \n    COALESCE(SUM(token_transaction_offset.amount), 0) AS balance\nFROM (\n    SELECT  \n        token_transaction.id,  \n        token_transaction.token,  \n        token_transaction.amount, \n        wallet_transaction.wallet, \n        wallet_transaction.created_at, \n        wallet_transaction.created_at + {{interval}} AS created_at_offset\n    FROM \n        token_transaction\n    INNER JOIN \n        wallet_transaction \n    ON \n        token_transaction.wallet_transaction = wallet_transaction.id\n) AS token_transaction_offset\nWHERE \n    token_transaction_offset.wallet = {{wallet}} \n    AND token_transaction_offset.token = {{token}} \n    AND token_transaction_offset.created_at_offset <= {{start}};"
      returns: balance_offset_model
      root_field_name: wallet_token_balance_ignore_interval
    - arguments:
        offset:
          description: ""
          nullable: false
          type: interval
      code: select *, created_at + {{offset}} as created_at_offset from wallet_transaction
      returns: wallet_transaction_offset_model
      root_field_name: wallet_transaction_offset
  tables: "!include default/tables/tables.yaml"
  functions: "!include default/functions/functions.yaml"
