user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/json;

    # Cache configuration
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=hasura_cache:10m 
                     max_size=10g inactive=60m use_temp_path=off;

    # Custom cache time mapping
    map $http_x_cache_time $cache_duration {
        default 30s;
        "5s"    5s;
        "15s"   15s;
        "30s"   30s;
        "1m"    1m;
        "5m"    5m;
        "10m"   10m;
        "30m"   30m;
        "1h"    1h;
    }

    server {
        listen 80;
        
        # GraphQL endpoint
        location /v1/graphql {
            proxy_pass http://graphql-engine:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            
            # Cache configuration
            proxy_cache hasura_cache;
            proxy_cache_methods POST;
            proxy_cache_key "$request_method$request_uri$request_body";
            proxy_cache_valid 200 $cache_duration;
            
            # Cache bypass
            proxy_cache_bypass $http_x_cache_bypass;
            
            # Add cache status to response headers
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Cache-Time $cache_duration;
        }
    }
}